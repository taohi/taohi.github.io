<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.3.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/coffee_32X32.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/coffee_16X16.png?v=6.3.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.3.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="涛海笔记 taohi Notes">
<meta property="og:type" content="website">
<meta property="og:title" content="taohi Notes">
<meta property="og:url" content="http://www.taohi.net/page/2/index.html">
<meta property="og:site_name" content="taohi Notes">
<meta property="og:description" content="涛海笔记 taohi Notes">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="taohi Notes">
<meta name="twitter:description" content="涛海笔记 taohi Notes">






  <link rel="canonical" href="http://www.taohi.net/page/2/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>taohi Notes</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">taohi Notes</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <h1 class="site-subtitle" itemprop="description">行百里半于九十，积跬步以至千里。</h1>
      
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-主页">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />主页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-分类">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分类</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-归档">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-书单">
    <a href="/books/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-book"></i> <br />书单</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-关于我">
    <a href="/about/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-user"></i> <br />关于我</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-sitemap">
    <a href="/sitemap.xml" rel="section">
      <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />站点地图</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />搜索</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.taohi.net/2015/04/17/graduation-note.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="taohi">
      <meta itemprop="description" content="涛海笔记 taohi Notes">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="taohi Notes">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/04/17/graduation-note.html" itemprop="url">
                  毕业事项记录
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              

              
                
              

              <time title="创建时间：2015-04-17 10:38:11" itemprop="dateCreated datePublished" datetime="2015-04-17T10:38:11+08:00">2015-04-17</time>
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/其他/" itemprop="url" rel="index"><span itemprop="name">其他</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="毕业论文及答辩"><a href="#毕业论文及答辩" class="headerlink" title="毕业论文及答辩"></a>毕业论文及答辩</h1><ul>
<li>论文被抽查到盲审(50%概率)，送校外和校内各一位专家审查。审查结果分ABCD。A可直接参加校内答辩。  </li>
<li>在学校内部hub系统上申请答辩。录入论文相关信息。 </li>
<li>制作答辩PPT。</li>
<li>参加答辩。</li>
<li>填写档案袋以及(共6种资料)签字盖章。</li>
<li>根据答辩，重新修改完善论文，最终定稿。和档案袋一起上交。  </li>
<li>在研究生院学位信息录入系统录入学位信息。  </li>
</ul>
<h1 id="三方办理流程"><a href="#三方办理流程" class="headerlink" title="三方办理流程"></a>三方办理流程</h1><ul>
<li>找工作，与公司签两方工作意向协议。这个用于让自己放心。  </li>
<li>拿到学校发的三方协议，自己签字，然后给公司盖章。  </li>
<li>公司寄回三方协议，在学校就业网站填好毕业去向登记。三方找学院盖章。</li>
<li>将三方找学校就业办盖章。给一份就业办，给一份学院，自己留一份，给一份公司。</li>
</ul>
<h1 id="三方毁约流程"><a href="#三方毁约流程" class="headerlink" title="三方毁约流程"></a>三方毁约流程</h1><p>因为和腾讯毁约。经历了三方毁约。发生在第一次给公司寄出三方之后。  </p>
<ul>
<li>找新单位开具工作接收函。  </li>
<li>打电话找腾讯HR协商毁约，赔偿5K违约金，腾讯寄回三方和毁约声明。  </li>
<li>拿三方、毁约声明、新单位接收函和个人毁约申请，去找学院盖章。  </li>
<li>拿上述一堆材料，去研究生就业办，登记并领取新三方。  </li>
<li>重新走正常三方办理流程。  </li>
</ul>
<h1 id="户口、档案和派遣-待写"><a href="#户口、档案和派遣-待写" class="headerlink" title="户口、档案和派遣(待写)"></a>户口、档案和派遣(待写)</h1><ul>
<li>带三方去和人才市场签订代理协议。  </li>
<li>毕业了把档案和户口托管到人才市场。托管户口需要劳动合同和社保证明     </li>
<li>党组织关系转移到公司。  </li>
</ul>
<h1 id="其他事项"><a href="#其他事项" class="headerlink" title="其他事项"></a>其他事项</h1><ul>
<li>填写研究生就业推荐表 </li>
<li>填写毕业研究生登记表 </li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.taohi.net/2015/02/12/linux-vfs.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="taohi">
      <meta itemprop="description" content="涛海笔记 taohi Notes">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="taohi Notes">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/02/12/linux-vfs.html" itemprop="url">
                  Linux虚拟文件系统
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              

              
                
              

              <time title="创建时间：2015-02-12 10:39:04" itemprop="dateCreated datePublished" datetime="2015-02-12T10:39:04+08:00">2015-02-12</time>
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux编程/" itemprop="url" rel="index"><span itemprop="name">Linux编程</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文Linux虚拟文件系统的几个重要对象。它们在Linux编程中比较重要。在进程编程等场景经常用到。</p>
<h2 id="file对象"><a href="#file对象" class="headerlink" title="file对象"></a>file对象</h2><p>file对象是在进程观点上，进程中打开的文件的表示。  </p>
<h2 id="dentry对象"><a href="#dentry对象" class="headerlink" title="dentry对象"></a>dentry对象</h2><p>它表示一个实际的文件。不同进程打开同一个文件时，它们有不同的file对象，但是最终指向同一个dentry对象。  </p>
<h2 id="inode对象"><a href="#inode对象" class="headerlink" title="inode对象"></a>inode对象</h2><p>linux将文件与文件的属性分开表示。inode对象包含了一个文件相关的所有属性信息。比如文件大小，文件权限，操作方法集，对应的块设备，修改时间等。  </p>
<h2 id="super-block对象"><a href="#super-block对象" class="headerlink" title="super_block对象"></a>super_block对象</h2><p>超级块对象。它包含磁盘上文件的一些元数据。是对文件系统具体的描述。  </p>
<p>如下两张图，能够将这些对象的关系看得很清楚。<br><img src="/2015/02/12/linux-vfs/dentry.jpg" title="dentry示意图"></p>
<img src="/2015/02/12/linux-vfs/VFS_struct.png" title="vfs详细结构体关系">
<h2 id="文件描述符"><a href="#文件描述符" class="headerlink" title="文件描述符"></a>文件描述符</h2><p>从上图知道，在进程中打开的文件，对应的文件描述符，就是file_struct结构体中，file指针数组fd_array的下标。所以，进程打开文件时，分配的文件描述符按照从小到大的值依次分配。有了文件描述符，内核就能够去索引对应的file结构体，从fops去获得对文件的操作函数集，以便对文件进行各种操作。  </p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.taohi.net/2015/02/12/malloc-sbrk.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="taohi">
      <meta itemprop="description" content="涛海笔记 taohi Notes">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="taohi Notes">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/02/12/malloc-sbrk.html" itemprop="url">
                  内存分配malloc与sbrk
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              

              
                
              

              <time title="创建时间：2015-02-12 10:07:25" itemprop="dateCreated datePublished" datetime="2015-02-12T10:07:25+08:00">2015-02-12</time>
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux编程/" itemprop="url" rel="index"><span itemprop="name">Linux编程</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>malloc是C库函数。用于分配堆内存。是在运行时分配存储空间的函数。<br>头文件: <code>stdlib.h</code><br>函数原型：void *malloc(unsigned int num_bytes);  </p>
<h2 id="C库函数malloc"><a href="#C库函数malloc" class="headerlink" title="C库函数malloc"></a>C库函数malloc</h2><h3 id="1-组织结构"><a href="#1-组织结构" class="headerlink" title="1.组织结构"></a>1.组织结构</h3><p>空闲存储空间以空闲链表的方式组织，每个块包含一个长度，一个指向下一块的指针，以及一个指向自身存储空间的指针。按照存储地址升序组织。最后一块指向第一块。<br><img src="/2015/02/12/malloc-sbrk/malloc_block.png" title="alloc的内存块结构"> </p>
<h3 id="2-分配过程"><a href="#2-分配过程" class="headerlink" title="2.分配过程"></a>2.分配过程</h3><p>有申请时，malloc顺序扫描空闲链表。直到找到一个足够大的块。算法为“首次适应”。寻找过程中，如果块大小等于需求大小，直接返回；如果块大小太大，分成两部分，一块为需求大小，将它返回(一般是块的后半部分)，另一块留在链表中；如果找不到足够大的块。调用sbrk向操作系统申请更大块加入空闲链表。</p>
<h3 id="3-释放过程"><a href="#3-释放过程" class="headerlink" title="3.释放过程"></a>3.释放过程</h3><p>free首先搜索空闲块链表，找到相邻空闲块，则合并为一块。避免碎片。<br><img src="/2015/02/12/malloc-sbrk/malloc_list.png" title="malloc块链表"></p>
<h2 id="Unix系统调用sbrk"><a href="#Unix系统调用sbrk" class="headerlink" title="Unix系统调用sbrk"></a>Unix系统调用sbrk</h2><p>函数原型：char *sbrk(int incr);  </p>
<p>它返回下一个内存空间。则sbrk(0)能得知堆的结束地址program break.<br>sbrk是一个Linux的系统调用。它增加或者减少堆空间的长度。完成虚拟地址到物理地址的映射。在malloc申请空间不足时，malloc会调用sbrk来申请更多的内存加入到空闲块链表上。如下图，sbrk就是移动堆的program break的位置。<br><img src="/2015/02/12/malloc-sbrk/LinuxProcLayout.png" title="Linux进程堆内存布局"></p>
<h2 id="malloc-free与new-delete"><a href="#malloc-free与new-delete" class="headerlink" title="malloc/free与new/delete"></a>malloc/free与new/delete</h2><ol>
<li>malloc是C标准库函数，new是C++的运算符。  </li>
<li>对于用户自定义的对象而言，用malloc/free不能够执行构造函数和析构函数。因为malloc是库函数，不受编译器控制。  </li>
<li>对于内置的数据对象，比如int char等，用new 和用malloc都可以。  </li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.taohi.net/2015/02/12/linux-kernel-timer.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="taohi">
      <meta itemprop="description" content="涛海笔记 taohi Notes">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="taohi Notes">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/02/12/linux-kernel-timer.html" itemprop="url">
                  Linux内核定时器
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              

              
                
              

              <time title="创建时间：2015-02-12 08:28:17" itemprop="dateCreated datePublished" datetime="2015-02-12T08:28:17+08:00">2015-02-12</time>
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux编程/" itemprop="url" rel="index"><span itemprop="name">Linux编程</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前提概念"><a href="#前提概念" class="headerlink" title="前提概念"></a>前提概念</h2><p><strong>HZ</strong>：节拍率.linux一秒钟中断的次数，一般是100<br><strong>jiffies</strong>：系统从启动到当前的节拍数。如果系统启动n秒了，则 jiffies = n*HZ  </p>
<p>头文件：linux/timer.h</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timer_list</span>&#123;</span></span><br><span class="line">       <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">entry</span>;</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> expires;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">tvec_base</span> *<span class="title">base</span>;</span></span><br><span class="line">        <span class="keyword">void</span> (*function) (<span class="keyword">unsigned</span> <span class="keyword">long</span>);</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> data;</span><br><span class="line">        .......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="使用步骤"><a href="#使用步骤" class="headerlink" title="使用步骤"></a>使用步骤</h2><ol>
<li>申请timer_list结构体 struct timer_list mytimer  </li>
<li>初始化定时器init_timer(&amp;mytimer)  </li>
<li>设置超时间隔，超时函数及其参数。  </li>
<li>编写超时后处理函数  </li>
<li>添加定时器add_timer(&amp;mytimer)  </li>
<li>最终删除定时器del_timer_sync(&amp;mytimer)，该函数多处理器安全。  </li>
</ol>
<h2 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/timer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/jiffies.h&gt;</span></span></span><br><span class="line">MODULE_LICENSE(<span class="string">"Dual BSD/GPL"</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timer_list</span> <span class="title">mytimer</span>;</span></span><br><span class="line"><span class="keyword">int</span> counter = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">mytimer_handler</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(<span class="string">"counter now:%d.\n"</span>,counter);</span><br><span class="line">    counter ++;</span><br><span class="line">    <span class="keyword">if</span> (counter &gt;<span class="number">20</span>)</span><br><span class="line">        counter = <span class="number">0</span>;</span><br><span class="line">    mod_timer(&amp;mytimer,jiffies + HZ);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span>  __<span class="function">init <span class="title">mytimer_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(<span class="string">"In function:%s\n"</span>,__func__);</span><br><span class="line">    init_timer(&amp;mytimer);</span><br><span class="line">    mytimer.expires = jiffies + HZ;</span><br><span class="line">    mytimer.data = jiffies;</span><br><span class="line">    mytimer.function = mytimer_handler;</span><br><span class="line">    add_timer(&amp;mytimer);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span>  __<span class="function"><span class="built_in">exit</span> <span class="title">mytimer_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(<span class="string">"In function:%s\n"</span>,__func__);</span><br><span class="line">    del_timer(&amp;mytimer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(mytimer_init);</span><br><span class="line">module_exit(mytimer_exit);</span><br></pre></td></tr></table></figure>
<p>程序中，每经过1秒定时器超时，count值加1并打印出来，然后mod_timer()修改定时器mytimer的expires值为再过1秒超时，再次激活定时器。  </p>
<h2 id="运行结果"><a href="#运行结果" class="headerlink" title="运行结果"></a>运行结果</h2><p>每隔一秒输出count值，count循环从0增加到20，直到手动卸载模块时，定时器被删除。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.taohi.net/2015/02/11/linux-multi-thread.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="taohi">
      <meta itemprop="description" content="涛海笔记 taohi Notes">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="taohi Notes">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/02/11/linux-multi-thread.html" itemprop="url">
                  Linux的多线程
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              

              
                
              

              <time title="创建时间：2015-02-11 14:48:04" itemprop="dateCreated datePublished" datetime="2015-02-11T14:48:04+08:00">2015-02-11</time>
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux编程/" itemprop="url" rel="index"><span itemprop="name">Linux编程</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一-Linux线程与进程的对比"><a href="#一-Linux线程与进程的对比" class="headerlink" title="一.Linux线程与进程的对比"></a>一.Linux线程与进程的对比</h2><h3 id="用户空间角度："><a href="#用户空间角度：" class="headerlink" title="用户空间角度："></a>用户空间角度：</h3><ol>
<li>新进程创建时，申请独立的地址空间，包括堆、栈、代码段、数据段、BSS段等。并初始化为父进程的值。此后父子进程不能直接互相访问这些资源。</li>
<li>新线程创建时，只申请独立线程栈，与同进程的其它线程共享进程地址空间，包括的代码段、数据段、BSS段、堆、打开的库、mmap映射的文件、共享内存空间。  </li>
</ol>
<h3 id="内核空间角度："><a href="#内核空间角度：" class="headerlink" title="内核空间角度："></a>内核空间角度：</h3><ol>
<li>Linux并不区分进程和线程。创建线程和进程时，都会创建新的PCB。</li>
<li>不同的是，新进程PCB的mm_struct会创建新地址空间；新线程PCB的mm_struct指向主进程的地址空间，与它共享。  </li>
</ol>
<h3 id="总的说来"><a href="#总的说来" class="headerlink" title="总的说来"></a>总的说来</h3><p><strong>进程</strong>是OS管理资源的基本单元；<strong>线程</strong>是Linux系统调度的基本单元。</p>
<h2 id="二-线程基本操作"><a href="#二-线程基本操作" class="headerlink" title="二.线程基本操作"></a>二.线程基本操作</h2><p>头文件：<code>pthread.h</code><br>由于是POSIX线程库，gcc编译时要加上<code>-pthread</code>选项。  </p>
<p><code>int pthread_create(p_tid,attr,func,arg);</code><br>创建线程。新线程从func处开始执行，arg为传递给func的参数。  </p>
<p><code>pthread_t pthead_self();</code><br>获取线程自身tid。  </p>
<p><code>pthread_exit(void *ptr);</code><br>线程由自身退出，返回信息放在ptr里。  </p>
<p><code>int pthread_join(tid, void **ptr);</code><br>等待线程tid退出。ptr存放tid退出时返回信息。  </p>
<p><code>int pthread_detach(tid);</code><br>使线程tid进入分离状态。即线程自身独立出来。</p>
<p><code>int pthread_cancel(tid);</code><br>取消同进程中的tid线程。它提出这个请求后立即返回。tid在可取消点的时候退出。  </p>
<p><code>void pthread_cleanup_push(func,arg);</code><br><code>void pthread_cleanup_pop(int execute);</code><br>设置线程退出时需要调用的函数。  </p>
<p>一个代码示例：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread_func</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"msg from main:%s\n"</span>,(<span class="keyword">char</span> *)arg);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"thread id:%u\n"</span>,(<span class="keyword">unsigned</span>)pthread_self());</span><br><span class="line">    pthread_exit(<span class="string">"I am thread,exited"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> tid;</span><br><span class="line">    <span class="keyword">void</span> *thread_ret;</span><br><span class="line">    pthread_create(&amp;tid,<span class="literal">NULL</span>,thread_func,<span class="string">"I am main"</span>);</span><br><span class="line">    pthread_join(tid,&amp;thread_ret);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"msg from thread:%s\n"</span>,(<span class="keyword">char</span> *)thread_ret);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>运行结果：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tao@taohi-xubuntu:~/linux_c$ ./pthread_exit</span><br><span class="line">msg from main:I am main</span><br><span class="line">thread id:3075636032</span><br><span class="line">msg from thread:I am thread,exited</span><br></pre></td></tr></table></figure></p>
<h2 id="三-线程私有数据"><a href="#三-线程私有数据" class="headerlink" title="三.线程私有数据"></a>三.线程私有数据</h2><p>一个全局变量，如果A线程修改了它，那么这个修改会在B线程可见。<br>为了使得线程有私有全局变量，有如下接口：<br><code>pthread_key_create(key,func);</code><br><code>pthread_key_delete(key);</code><br><code>pthread_setspecific(key,ptr);</code><br><code>pthread_getspecific(key);</code>  </p>
<p>示例代码如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">pthread_key_t</span> key;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">tid1_func</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i=<span class="number">10</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"set key:%d in tid1\n"</span>,i);</span><br><span class="line">    pthread_setspecific(key,&amp;i);</span><br><span class="line">    sleep(<span class="number">2</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"in tid1,after tid2 ends,key:%d\n"</span>,*(<span class="keyword">int</span> *)pthread_getspecific(key));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">tid2_func</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> j=<span class="number">20</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"set key:%d in tid2\n"</span>,j);</span><br><span class="line">    pthread_setspecific(key,&amp;j);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"in tid2,key:%d\n"</span>,*(<span class="keyword">int</span> *)pthread_getspecific(key));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">destruct</span><span class="params">(<span class="keyword">void</span> *t)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"key addr:%p\n"</span>,t);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> tid1,tid2;</span><br><span class="line">    pthread_key_create(&amp;key,destruct);</span><br><span class="line">    pthread_create(&amp;tid1,<span class="literal">NULL</span>,tid1_func,<span class="literal">NULL</span>);</span><br><span class="line">    pthread_create(&amp;tid2,<span class="literal">NULL</span>,tid2_func,<span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(tid1,<span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(tid2,<span class="literal">NULL</span>);</span><br><span class="line">    pthread_key_delete(key);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>运行结果：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tao@taohi-xubuntu:~/linux_c$ ./pthread_key</span><br><span class="line"><span class="built_in">set</span> key:10 <span class="keyword">in</span> tid1</span><br><span class="line"><span class="built_in">set</span> key:20 <span class="keyword">in</span> tid2</span><br><span class="line"><span class="keyword">in</span> tid2,key:20</span><br><span class="line">key addr:0xb6d8934c</span><br><span class="line"><span class="keyword">in</span> tid1,after tid2 ends,key:10</span><br><span class="line">key addr:0xb758a34c</span><br></pre></td></tr></table></figure></p>
<h2 id="四-线程同步方法"><a href="#四-线程同步方法" class="headerlink" title="四.线程同步方法"></a>四.线程同步方法</h2><p>线程并发访问共享资源，带来不确定性。所以需要同步机制。  </p>
<h3 id="4-1互斥锁mutex"><a href="#4-1互斥锁mutex" class="headerlink" title="4.1互斥锁mutex"></a>4.1互斥锁mutex</h3><p>互斥锁是二元变量。线程只有获得锁，才能操作临界资源。操作完释放锁。<br>造成死锁原因：</p>
<ol>
<li>线程对同一个互斥锁加锁两次；</li>
<li>A拥有甲锁，等乙锁，同时B拥有乙锁，等甲锁。  </li>
</ol>
<p>使用接口：<br>pthread_mutex my_mutex;<br>pthread_mutex_init(&amp;my_mutex,NULL);<br>pthread_mutex_lock(&amp;my_mutex); 试着加锁，锁不上就阻塞等待加锁。<br>pthread_mutex_trylock(&amp;my_mutex);   试着加锁，锁不上就返回<br>pthread_mutex_unlock(&amp;my_mutex);<br>pthread_mutex_destroy(&amp;my_mutex);   </p>
<h3 id="4-2读写锁"><a href="#4-2读写锁" class="headerlink" title="4.2读写锁"></a>4.2读写锁</h3><p>读写锁比互斥锁并发度更高:<br>如果A线程获得写锁：其他线程不能获得任何锁；<br>如果A线程获得读锁：其他线程可以获得读锁，不能获得写锁。   </p>
<p>使用接口：<br>pthread_rwlock_t rwlock;<br>pthread_rwlock_init(&amp;rwlock,NULL);<br>pthread_rwlock_destroy(&amp;rwlock);<br>pthread_rwlock_rdlock(&amp;rwlock);<br>pthread_rwlock_wrlock(&amp;rwlock);<br>pthread_rwlock_unlock(&amp;rwlock);  </p>
<h3 id="4-3条件变量"><a href="#4-3条件变量" class="headerlink" title="4.3条件变量"></a>4.3条件变量</h3><p>默默忽略  </p>
<h2 id="五-线程和信号"><a href="#五-线程和信号" class="headerlink" title="五.线程和信号"></a>五.线程和信号</h2><ol>
<li>每个线程有单独的信号屏蔽集合。  </li>
<li>对同一个信号，所有线程共享相同的信号处理程序。比如线程1注册了SIGUSR1的处理函数，那么线程2收到SIGUSR1也会去调用这个处理函数。  </li>
<li>如果一个线程收到终止信号，其他所有线程都将终止。  </li>
</ol>
<p>线程操作接口：<br><code>pthread_kill(tid,signo);</code><br>向线程tid发送signo信号。  </p>
<p><code>pthread_procmask(how,mask,oldmask);</code><br>设置线程信号屏蔽集合。   </p>
<p><code>sigwait()</code>等待一个或者多个信号发生。  </p>
<p>代码示例：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sig_handler</span><span class="params">(<span class="keyword">int</span> signo)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"tid=%u,sig=%d\n"</span>,(<span class="keyword">unsigned</span> <span class="keyword">int</span>)pthread_self(),signo);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">tid1_func</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">sigset_t</span> <span class="built_in">set</span>;</span><br><span class="line">    signal(SIGUSR1,sig_handler);</span><br><span class="line">    sigfillset(&amp;<span class="built_in">set</span>);</span><br><span class="line">    sigdelset(&amp;<span class="built_in">set</span>,SIGUSR2);</span><br><span class="line">    pthread_sigmask(SIG_SETMASK,&amp;<span class="built_in">set</span>,<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"tid1=%u, set mask.\n"</span>,(<span class="keyword">unsigned</span> <span class="keyword">int</span>)pthread_self());</span><br><span class="line">        pause();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">tid2_func</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    signal(SIGUSR2,sig_handler);</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"tid2=%u, not set mask.\n"</span>,(<span class="keyword">unsigned</span> <span class="keyword">int</span>)pthread_self());</span><br><span class="line">        pause();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc ,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> tid1,tid2;</span><br><span class="line">    pthread_create(&amp;tid1,<span class="literal">NULL</span>,tid1_func,<span class="literal">NULL</span>);</span><br><span class="line">    pthread_create(&amp;tid2,<span class="literal">NULL</span>,tid2_func,<span class="literal">NULL</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    pthread_kill(tid1,SIGUSR1);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    pthread_kill(tid1,SIGUSR1);</span><br><span class="line">    pthread_kill(tid1,SIGUSR2);</span><br><span class="line">    pthread_kill(tid2,SIGUSR1);</span><br><span class="line">    pthread_kill(tid2,SIGUSR2);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    pthread_kill(tid1,SIGKILL);</span><br><span class="line">    pthread_join(tid1,<span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(tid2,<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>运行结果：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">tao@taohi-xubuntu:~/linux_c$ ./pthread_signal  </span><br><span class="line">tid1=3076352832, set mask.         </span><br><span class="line">tid2=3067960128, not set mask. </span><br><span class="line">tid=3076352832,sig=12  </span><br><span class="line">tid=3067960128,sig=12  </span><br><span class="line">tid=3067960128,sig=10  </span><br><span class="line">tid2=3067960128, not set mask.</span><br><span class="line">tid1=3076352832, set mask.</span><br><span class="line">已杀死</span><br></pre></td></tr></table></figure></p>
<h2 id="六-线程属性控制"><a href="#六-线程属性控制" class="headerlink" title="六.线程属性控制"></a>六.线程属性控制</h2><p><code>int pthread_attr_getstacksize(pthread_attr_t *attr, size_t *stacksize);</code><br>获取线程栈大小。通过stacksize指针返回。  </p>
<p><code>int pthread_attr_setstacksize(pthread_attr_t *attr, size_t  stacksize);</code><br>设置线程栈大小。  </p>
<p>示例代码：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">tid_func</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_attr_t</span> attr;</span><br><span class="line">    <span class="keyword">size_t</span> stack_size=<span class="number">0</span>;</span><br><span class="line">    pthread_attr_getstacksize(&amp;attr,&amp;stack_size);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"default pthread stack size:%d KB\n"</span>,stack_size/<span class="number">1024</span>);</span><br><span class="line">    stack_size=<span class="number">4</span>*<span class="number">1024</span>*<span class="number">1024</span>;</span><br><span class="line">    pthread_attr_setstacksize(&amp;attr,stack_size);</span><br><span class="line">    pthread_attr_getstacksize(&amp;attr,&amp;stack_size);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"after modify,stack size:%d KB\n"</span>,stack_size/<span class="number">1024</span>);</span><br><span class="line">    pthread_exit(<span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc ,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> tid;</span><br><span class="line">    pthread_create(&amp;tid,<span class="literal">NULL</span>,tid_func,<span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(tid,<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>输出结果:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tao@taohi-xubuntu:~/linux_c$ ./pthread_stack</span><br><span class="line">default pthread stack size:8192 KB</span><br><span class="line">after modify,stack size:4096 KB</span><br></pre></td></tr></table></figure></p>
<p>可以看到linux下线程默认栈大小为8M   </p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.taohi.net/2015/02/11/ipc-share-memory.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="taohi">
      <meta itemprop="description" content="涛海笔记 taohi Notes">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="taohi Notes">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/02/11/ipc-share-memory.html" itemprop="url">
                  Linux进程间通信之六：共享内存
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              

              
                
              

              <time title="创建时间：2015-02-11 12:14:00" itemprop="dateCreated datePublished" datetime="2015-02-11T12:14:00+08:00">2015-02-11</time>
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux编程/" itemprop="url" rel="index"><span itemprop="name">Linux编程</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>共享内存允许两个进程共享一个给定的存储区。所以数据不需要在两个进程间复制。这是最快的一种IPC。<br>头文件:<code>sys/shm.h</code></p>
<h2 id="一-共享内存示意图↓"><a href="#一-共享内存示意图↓" class="headerlink" title="一.共享内存示意图↓"></a>一.共享内存示意图↓</h2><img src="/2015/02/11/ipc-share-memory/shm_layout.png" title="内存示意图">  
<h2 id="二-地址映射示意图↓-APUE"><a href="#二-地址映射示意图↓-APUE" class="headerlink" title="二.地址映射示意图↓(APUE)"></a>二.地址映射示意图↓(APUE)</h2><img src="/2015/02/11/ipc-share-memory/shm_addr_map.png" title="地址映射示意图">  
<h2 id="三-共享内存的数据结构shmid-ds"><a href="#三-共享内存的数据结构shmid-ds" class="headerlink" title="三.共享内存的数据结构shmid_ds"></a>三.共享内存的数据结构shmid_ds</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">shmid_ds</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ipc_perm</span> <span class="title">shm_perm</span>;</span> <span class="comment">/* see Section 15.6.2 */</span></span><br><span class="line"><span class="keyword">size_t</span> shm_segsz; <span class="comment">/* size of segment in bytes */</span></span><br><span class="line"><span class="keyword">pid_t</span> shm_lpid; <span class="comment">/* pid of last shmop() */</span></span><br><span class="line"><span class="keyword">pid_t</span> shm_cpid; <span class="comment">/* pid of creator */</span></span><br><span class="line"><span class="keyword">shmatt_t</span> shm_nattch; <span class="comment">/* number of current attaches */</span></span><br><span class="line"><span class="keyword">time_t</span> shm_atime; <span class="comment">/* last-attach time */</span></span><br><span class="line"><span class="keyword">time_t</span> shm_dtime; <span class="comment">/* last-detach time */</span></span><br><span class="line"><span class="keyword">time_t</span> shm_ctime; <span class="comment">/* last-change time */</span></span><br><span class="line">.....</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="四-共享内存操作接口"><a href="#四-共享内存操作接口" class="headerlink" title="四.共享内存操作接口"></a>四.共享内存操作接口</h2><ol>
<li>创建:shmget()</li>
<li>控制:shmctl()</li>
<li>挂载映射:shmat()</li>
<li>分离:shmdt()</li>
<li>删除:shmctl(shm_id,IPC_RMID,0)</li>
</ol>
<h2 id="五-注意事项"><a href="#五-注意事项" class="headerlink" title="五.注意事项"></a>五.注意事项</h2><ol>
<li>进程操作共享内存区，要注意同步问题，可用信号量来同步。</li>
<li>根据进程知识，fork一个子进程，它继承父进程挂载的共享内存。</li>
<li>如果用exec执行新程序，则挂载的共享内存将被卸载。</li>
<li>如果进程调用exit()，则挂载的共享内存与进程脱离关系。</li>
</ol>
<h2 id="六-示例代码"><a href="#六-示例代码" class="headerlink" title="六.示例代码"></a>六.示例代码</h2><p>利用信号量来给共享内存区同步。<br>发送端：如果信号量为0，往共享区写数据，将信号量加1；<br>接收端：如果信号量为1，读出共享区数据，将信号量减1。<br>如果接收到“end”，则删除共享内存，信号量。通信结束。  </p>
<p>发送端代码：(为了简洁没有做错误处理)<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//shm_sem_sender.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> running = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> shmid;</span><br><span class="line">    <span class="keyword">int</span> semid;</span><br><span class="line">    <span class="keyword">int</span> value;</span><br><span class="line">    <span class="keyword">void</span> *share_memp=<span class="literal">NULL</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sembuf</span> <span class="title">sem</span>;</span></span><br><span class="line">    sem.sem_num=<span class="number">0</span>;</span><br><span class="line">    sem.sem_flg=SEM_UNDO;</span><br><span class="line">    semid=semget((<span class="keyword">key_t</span>)<span class="number">123456</span>,<span class="number">1</span>,<span class="number">0666</span>|IPC_CREAT);</span><br><span class="line">    <span class="comment">//设置信号初始值为0</span></span><br><span class="line">    semctl(semid,<span class="number">0</span>,SETVAL,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    shmid=shmget((<span class="keyword">key_t</span>)<span class="number">654321</span>,(<span class="keyword">size_t</span>)<span class="number">2048</span>,<span class="number">0600</span>|IPC_CREAT);</span><br><span class="line">    share_memp = shmat(shmid,<span class="literal">NULL</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">while</span>(running)</span><br><span class="line">    &#123;</span><br><span class="line">        value=semctl(semid,<span class="number">0</span>,GETVAL);</span><br><span class="line">        <span class="keyword">if</span>(value==<span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"write data operate\n"</span>);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"please input:"</span>);</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">"%s"</span>,(<span class="keyword">char</span> *)share_memp);</span><br><span class="line">            sem.sem_op=<span class="number">1</span>;</span><br><span class="line">            semop(semid,&amp;sem,<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strcmp</span>(share_memp,<span class="string">"end"</span>)==<span class="number">0</span>)</span><br><span class="line">            running--;</span><br><span class="line">    &#125;</span><br><span class="line">    shmdt(share_memp);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接收端代码：(为了简洁没有做错误处理)<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//shm_sem_recv.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> running = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> shmid;</span><br><span class="line">    <span class="keyword">int</span> semid;</span><br><span class="line">    <span class="keyword">int</span> value;</span><br><span class="line">    <span class="keyword">void</span> *share_memp=<span class="literal">NULL</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sembuf</span> <span class="title">sem</span>;</span></span><br><span class="line">    sem.sem_num=<span class="number">0</span>;</span><br><span class="line">    sem.sem_flg=SEM_UNDO;</span><br><span class="line">    semid=semget((<span class="keyword">key_t</span>)<span class="number">123456</span>,<span class="number">1</span>,<span class="number">0666</span>|IPC_CREAT);</span><br><span class="line">    <span class="comment">//设置信号初始值为0</span></span><br><span class="line">    semctl(semid,<span class="number">0</span>,SETVAL,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    shmid=shmget((<span class="keyword">key_t</span>)<span class="number">654321</span>,(<span class="keyword">size_t</span>)<span class="number">2048</span>,<span class="number">0600</span>|IPC_CREAT);</span><br><span class="line">    share_memp = shmat(shmid,<span class="literal">NULL</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">while</span>(running)</span><br><span class="line">    &#123;</span><br><span class="line">        value=semctl(semid,<span class="number">0</span>,GETVAL);</span><br><span class="line">        <span class="keyword">if</span>(value==<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"read data operate\n"</span>);</span><br><span class="line">            sem.sem_op=<span class="number">-1</span>;</span><br><span class="line">            semop(semid,&amp;sem,<span class="number">1</span>);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%s"</span>,(<span class="keyword">char</span> *)share_memp);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strcmp</span>(share_memp,<span class="string">"end"</span>)==<span class="number">0</span>)</span><br><span class="line">            running--;</span><br><span class="line">    &#125;</span><br><span class="line">    shmdt(share_memp);</span><br><span class="line">    shmctl(shmid,IPC_RMID,<span class="number">0</span>);</span><br><span class="line">    semctl(semid,IPC_RMID,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.taohi.net/2015/02/11/ipc-msg-semaphore.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="taohi">
      <meta itemprop="description" content="涛海笔记 taohi Notes">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="taohi Notes">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/02/11/ipc-msg-semaphore.html" itemprop="url">
                  Linux进程间通信四、五：信号量和消息队列
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              

              
                
              

              <time title="创建时间：2015-02-11 11:02:32" itemprop="dateCreated datePublished" datetime="2015-02-11T11:02:32+08:00">2015-02-11</time>
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux编程/" itemprop="url" rel="index"><span itemprop="name">Linux编程</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>System V提供的IPC机制有三种：信号量、消息队列、共享内存。本文介绍前两种。<br>头文件:<code>sys/msg.h</code> 和 <code>sys/ipc.h</code><br>使用ipcs可以查看系统正使用的IPC工具：<br><img src="/2015/02/11/ipc-msg-semaphore/ipcs.png" title="ipcs命令">  </p>
<h2 id="IPC的ID与key键"><a href="#IPC的ID与key键" class="headerlink" title="IPC的ID与key键"></a>IPC的ID与key键</h2><p>每一个IPC都用唯一的ID来标识、使用。一般利用key键来获得一个IPC的ID。而key可以通过<code>ftok()</code>产生。<br><code>key_t ftok(char *pathname,int id);</code></p>
<h2 id="IPC权限结构ipc-perm"><a href="#IPC权限结构ipc-perm" class="headerlink" title="IPC权限结构ipc_perm"></a>IPC权限结构ipc_perm</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ipc_perm</span>&#123;</span></span><br><span class="line">    <span class="keyword">uid_t</span> uid;</span><br><span class="line">    <span class="keyword">gid_t</span> gid;</span><br><span class="line">    <span class="keyword">uid_t</span> cuid;</span><br><span class="line">    <span class="keyword">gid_t</span> cgid;</span><br><span class="line">    <span class="keyword">mode_t</span> mode;</span><br><span class="line">    ......</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="进程通信之五：消息队列通信"><a href="#进程通信之五：消息队列通信" class="headerlink" title="进程通信之五：消息队列通信"></a>进程通信之五：消息队列通信</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msqid_ds</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ipc_perm</span> <span class="title">msg_perm</span>;</span>  </span><br><span class="line"><span class="keyword">msgqnum_t</span> msg_qnum;        <span class="comment">/* # of messages on queue */</span></span><br><span class="line"><span class="keyword">msglen_t</span> msg_qbytes;        <span class="comment">/* max # of bytes on queue */</span></span><br><span class="line"><span class="keyword">pid_t</span> msg_lspid;           <span class="comment">/* pid of last msgsnd() */</span></span><br><span class="line"><span class="keyword">pid_t</span> msg_lrpid;           <span class="comment">/* pid of last msgrcv() */</span></span><br><span class="line"><span class="keyword">time_t</span> msg_stime;           <span class="comment">/* last-msgsnd() time */</span></span><br><span class="line"><span class="keyword">time_t</span> msg_rtime;          <span class="comment">/* last-msgrcv() time */</span></span><br><span class="line"><span class="keyword">time_t</span> msg_ctime;           <span class="comment">/* last-change time */</span></span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>代码示例：发送端和接收端利用消息队列进行通信。通信示意图：<br><img src="/2015/02/11/ipc-msg-semaphore/IPC_msg.png" title="IPC_msg"><br>发送端代码如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//msg_sender</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KEY_PATH  <span class="meta-string">"/home/tao"</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msgbuf</span>&#123;</span></span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">char</span> ptr[<span class="number">0</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">key_t</span> key;</span><br><span class="line">    key=ftok(KEY_PATH,<span class="number">100</span>);</span><br><span class="line">    <span class="keyword">int</span> msgid;</span><br><span class="line">    msgid=msgget(key,IPC_CREAT|<span class="number">0600</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"msgid=%d\n"</span>,msgid);</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    pid=fork();</span><br><span class="line">    <span class="keyword">if</span>(pid==<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"input msg to be sent:"</span>);</span><br><span class="line">            <span class="keyword">char</span> buf[<span class="number">128</span>];</span><br><span class="line">            fgets(buf,<span class="number">128</span>,<span class="built_in">stdin</span>);</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">msgbuf</span> *<span class="title">ptr</span> = <span class="title">malloc</span>(<span class="title">sizeof</span>(<span class="title">struct</span> <span class="title">msgbuf</span>)+<span class="title">strlen</span>(<span class="title">buf</span>)+1);</span></span><br><span class="line">            ptr-&gt;type=<span class="number">1</span>;<span class="comment">//发送消息类型为1的消息</span></span><br><span class="line">            <span class="built_in">memcpy</span>(ptr-&gt;ptr,buf,<span class="built_in">strlen</span>(buf)+<span class="number">1</span>);</span><br><span class="line">            msgsnd(msgid,ptr,<span class="built_in">strlen</span>(buf)+<span class="number">1</span>,<span class="number">0</span>);</span><br><span class="line">            <span class="built_in">free</span>(ptr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">   &#123;</span><br><span class="line">        struct msgbuf&#123;</span><br><span class="line">            <span class="keyword">int</span> type;</span><br><span class="line">            <span class="keyword">char</span> ptr[<span class="number">1024</span>];</span><br><span class="line">        &#125;;</span><br><span class="line">       <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">msgbuf</span> <span class="title">mybuf</span>;</span></span><br><span class="line">            <span class="built_in">memset</span>(&amp;mybuf,<span class="string">'\0'</span>,<span class="number">1024</span>);</span><br><span class="line">            msgrcv(msgid,&amp;mybuf,<span class="number">1024</span>,<span class="number">2</span>,<span class="number">0</span>);<span class="comment">//接受消息类型为2的消息</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"receive msg:%s\n"</span>,mybuf.ptr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接收端代码如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//msg_receiver</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KEY_PATH  <span class="meta-string">"/home/tao"</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msgbuf</span>&#123;</span></span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">char</span> ptr[<span class="number">0</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">key_t</span> key;</span><br><span class="line">    key=ftok(KEY_PATH,<span class="number">100</span>);</span><br><span class="line">    <span class="keyword">int</span> msgid;</span><br><span class="line">    msgid=msgget(key,IPC_CREAT|<span class="number">0600</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"msgid=%d\n"</span>,msgid);</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    pid=fork();</span><br><span class="line">    <span class="keyword">if</span>(pid==<span class="number">0</span>)<span class="comment">//子进程发送消息</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"input msg to be sent:"</span>);</span><br><span class="line">            <span class="keyword">char</span> buf[<span class="number">128</span>];</span><br><span class="line">            fgets(buf,<span class="number">128</span>,<span class="built_in">stdin</span>);</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">msgbuf</span> *<span class="title">ptr</span> = <span class="title">malloc</span>(<span class="title">sizeof</span>(<span class="title">struct</span> <span class="title">msgbuf</span>)+<span class="title">strlen</span>(<span class="title">buf</span>)+1);</span></span><br><span class="line">            ptr-&gt;type=<span class="number">2</span>; <span class="comment">//发送消息类型为2的消息</span></span><br><span class="line">            <span class="built_in">memcpy</span>(ptr-&gt;ptr,buf,<span class="built_in">strlen</span>(buf)+<span class="number">1</span>);</span><br><span class="line">            msgsnd(msgid,ptr,<span class="built_in">strlen</span>(buf)+<span class="number">1</span>,<span class="number">0</span>);</span><br><span class="line">            <span class="built_in">free</span>(ptr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        struct msgbuf&#123;</span><br><span class="line">            <span class="keyword">int</span> type;</span><br><span class="line">            <span class="keyword">char</span> ptr[<span class="number">1024</span>];</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">msgbuf</span> <span class="title">mybuf</span>;</span></span><br><span class="line">            <span class="built_in">memset</span>(&amp;mybuf,<span class="string">'\0'</span>,<span class="number">1024</span>);</span><br><span class="line">            <span class="keyword">int</span> ret=msgrcv(msgid,&amp;mybuf,<span class="number">1024</span>,<span class="number">1</span>,<span class="number">0</span>);<span class="comment">//接受消息类型为1的消息</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"receive msg:%s\n"</span>,mybuf.ptr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="进程通信之四：信号量通信"><a href="#进程通信之四：信号量通信" class="headerlink" title="进程通信之四：信号量通信"></a>进程通信之四：信号量通信</h2><p>一般用于避免并发访问共享资源。比如生产者消费者问题。<br>用的比较少。没啥好说的。需要时补充。  </p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.taohi.net/2015/02/03/ipc-signal.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="taohi">
      <meta itemprop="description" content="涛海笔记 taohi Notes">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="taohi Notes">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/02/03/ipc-signal.html" itemprop="url">
                  Linux进程间通信之三：信号
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              

              
                
              

              <time title="创建时间：2015-02-03 18:09:43" itemprop="dateCreated datePublished" datetime="2015-02-03T18:09:43+08:00">2015-02-03</time>
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux编程/" itemprop="url" rel="index"><span itemprop="name">Linux编程</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          信号是进程间唯一异步通信机制，是一种软中断。本文介绍Linux下信号处理方式。文章分6部分：一、信号基本工作原理；二、信号集结构体sigset_t；三、发送信号；四、安装信号；五、信号的屏蔽；六、等待信号。
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2015/02/03/ipc-signal.html">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.taohi.net/2015/02/03/ipc-fifo.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="taohi">
      <meta itemprop="description" content="涛海笔记 taohi Notes">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="taohi Notes">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/02/03/ipc-fifo.html" itemprop="url">
                  Linux进程间通信之二：有名管道FIFO
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              

              
                
              

              <time title="创建时间：2015-02-03 15:52:09" itemprop="dateCreated datePublished" datetime="2015-02-03T15:52:09+08:00">2015-02-03</time>
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux编程/" itemprop="url" rel="index"><span itemprop="name">Linux编程</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>有名管道FIFO是一个特殊文件。但并不是将信息真正存到磁盘，而是存到内存中。<br>两个完全没有关联的进程，通过访问这个管道文件，实现进程间通信。</p>
<h2 id="头文件"><a href="#头文件" class="headerlink" title="头文件"></a>头文件</h2><p><code>#include &lt;sys/types.h&gt;</code><br><code>#include&lt;sys/stat.h&gt;</code><br><code>int mkfifo(const char *pathname, mode_t mode);</code></p>
<h2 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h2><ol>
<li>创建一个FIFO文件：mkfifo(“/tmp/fifo”,0766)。</li>
<li>A进程以写方式打开FIFO文件：open(FIFO文件,O_WRONLY),调用<code>write</code>往里写数据。</li>
<li>B进程以读方式打开FIFO文件：open(FIFO文件,O_RDONLY),调用<code>read</code>读出数据。</li>
</ol>
<h2 id="阻塞现象"><a href="#阻塞现象" class="headerlink" title="阻塞现象"></a>阻塞现象</h2><ol>
<li>A进程以写(读)方式打开FIFO，将会阻塞在open()，直到B以读(写)方式打开FIFO。</li>
<li>默认方式下，若管道没有数据，读操作阻塞，直到有数据被写入。</li>
<li>默认方式下，若管道数据满了，写操作阻塞，直到有数据被读出。</li>
</ol>
<h2 id="实例代码"><a href="#实例代码" class="headerlink" title="实例代码"></a>实例代码</h2><p>程序<code>fifo_write</code>向管道写入数据<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FIFO <span class="meta-string">"/tmp/fifo"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pipe_fd;</span><br><span class="line">    <span class="keyword">int</span> res;</span><br><span class="line">    <span class="keyword">char</span> buffer[]=<span class="string">"helloworld!"</span>;</span><br><span class="line">    res=mkfifo(FIFO,<span class="number">0766</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"PID %d opening FIFO O_WRONLY.\n"</span>,getpid());</span><br><span class="line"></span><br><span class="line">    pipe_fd=open(FIFO,O_WRONLY);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"pipe_fd=%d.\n"</span>,pipe_fd);</span><br><span class="line">    <span class="keyword">if</span>(pipe_fd!=<span class="number">-1</span>)</span><br><span class="line">        res=write(pipe_fd,buffer,<span class="keyword">sizeof</span>(buffer));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"PID %d finished.\n"</span>,getpid());</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>程序<code>fifo_read</code>从管道读出数据：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FIFO <span class="meta-string">"/tmp/fifo"</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pipe_fd;</span><br><span class="line">    <span class="keyword">int</span> bytes_read=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> buffer[<span class="number">4096</span>];</span><br><span class="line">    <span class="built_in">memset</span>(buffer,<span class="string">'\0'</span>,<span class="number">4096</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"PID %d opening FIFO O_WRONLY.\n"</span>,getpid());</span><br><span class="line"></span><br><span class="line">    pipe_fd=open(FIFO,O_RDONLY);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"pipe_fd=%d.\n"</span>,pipe_fd);</span><br><span class="line">    <span class="keyword">if</span>(pipe_fd!=<span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        bytes_read=read(pipe_fd,buffer,<span class="keyword">sizeof</span>(buffer));</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"read data:%s\n"</span>,buffer);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"PID %d finished.\n"</span>,getpid());</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="运行结果"><a href="#运行结果" class="headerlink" title="运行结果"></a>运行结果</h2><p>先在A窗口执行<code>fifo_write</code>，结果如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tao@taohi-xubuntu:~$ ./fifo_write</span><br><span class="line">PID 5163 opening FIFO O_WRONLY.</span><br></pre></td></tr></table></figure></p>
<p>根据前面提到的阻塞现象，fifo_write阻塞在open()。  </p>
<p>然后在B窗口执行<code>fifo_read</code>，结果如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tao@taohi-xubuntu:~$ ./fifo_read</span><br><span class="line">PID <span class="number">5165</span> opening FIFO O_WRONLY.</span><br><span class="line">pipe_fd=<span class="number">3.</span></span><br><span class="line">read data:helloworld!</span><br><span class="line">PID <span class="number">5165</span> finished.</span><br></pre></td></tr></table></figure></p>
<p>此时观察B窗口，不再被阻塞，结果如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tao@taohi-xubuntu:~$ ./fifo_write</span><br><span class="line">PID 5163 opening FIFO O_WRONLY.</span><br><span class="line">pipe_fd=3.</span><br><span class="line">PID 5163 finished.</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.taohi.net/2015/02/03/ipc-pipe.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="taohi">
      <meta itemprop="description" content="涛海笔记 taohi Notes">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="taohi Notes">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/02/03/ipc-pipe.html" itemprop="url">
                  Linux进程间通信之一：无名管道PIPE
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              

              
                
              

              <time title="创建时间：2015-02-03 13:07:59" itemprop="dateCreated datePublished" datetime="2015-02-03T13:07:59+08:00">2015-02-03</time>
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux编程/" itemprop="url" rel="index"><span itemprop="name">Linux编程</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><p>无名管道是一种特殊类型文件。内核资源对应一段特殊内存。管道的数据流是单向的。  </p>
<p>命令<code>ulimit -p</code> 查看管道最大值限制，默认为8*512Byte=4KB。由limit.h的宏PIPE_BUF定义。  </p>
<p>头文件：<code>#include &lt;unistd.h&gt;</code>  </p>
<p>原型：<code>int pipe(int pipefd[2]);</code></p>
<p>若执行成功，pipefd内将存储两个文件描述符，指向管道的两端(pipefd[0]读,pipefd[1]写);<br>若执行失败，返回值为-1。  </p>
<p>读写管道用系统调用<code>read</code>和<code>write</code>，默认以阻塞方式读写。  </p>
<h2 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h2><img src="/2015/02/03/ipc-pipe/PIPE.png" title="PIPE原理图">  
<h2 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a>示例代码</h2><p>实现管道操作<code>ls /home/tao|sort</code><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">if</span>(pipe(fd)==<span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">"pipe"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(fork() == <span class="number">0</span>)<span class="comment">//child process.用于sort</span></span><br><span class="line">    &#123;</span><br><span class="line">        dup2(fd[<span class="number">0</span>],<span class="number">0</span>);</span><br><span class="line">        close(fd[<span class="number">1</span>]);</span><br><span class="line">        execlp(<span class="string">"sort"</span>,<span class="string">"sort"</span>,(<span class="keyword">char</span> *)<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(fork()==<span class="number">0</span>)<span class="comment">//child process.用于ls</span></span><br><span class="line">        &#123;</span><br><span class="line">            dup2(fd[<span class="number">1</span>],<span class="number">1</span>);</span><br><span class="line">            close(fd[<span class="number">0</span>]);</span><br><span class="line">            execlp(<span class="string">"ls"</span>,<span class="string">"ls"</span>,<span class="string">"/home/tao"</span>,(<span class="keyword">char</span> *)<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            close(fd[<span class="number">0</span>]);</span><br><span class="line">            close(fd[<span class="number">1</span>]);</span><br><span class="line">            wait(<span class="literal">NULL</span>);</span><br><span class="line">            wait(<span class="literal">NULL</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>程序说明</strong>：主进程分别fork了两个子进程，主进程产生的管道由两个子进程共享使用(管道是文件，根据进程fork的原理，父子进程共享打开的管道文件)。一个子进程执行ls，用dup2将标准输出重定向到管道写端fd[1]，另一个子进程执行sort，dup2将标准输入重定向到fd[0],于是它从管道读端fd[0]获取需要sort的数据。这样就实现了主进程的两个子进程的通信。  </p>
<p><strong>执行结果</strong>：和执行 ls  /home/tao|sort一模一样。  </p>
<p>可以看出，为了共享同样的文件描述符，无名管道适合这种<strong>亲缘关系接近</strong>的子进程之间通信。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">taohi</p>
              <p class="site-description motion-element" itemprop="description">涛海笔记 taohi Notes</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives">
                
                    <span class="site-state-item-count">40</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">8</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">57</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/taohi" target="_blank" title="GitHub" rel="external nofollow"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="http://www.xiachufang.com/cook/125193144/cooked/" target="_blank" title="我的厨房" rel="external nofollow"><i class="fa fa-fw fa-tree"></i>我的厨房</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://www.douban.com/people/taohi/" target="_blank" title="豆瓣" rel="external nofollow"><i class="fa fa-fw fa-edge"></i>豆瓣</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:taohi@taohi.net" target="_blank" title="电子邮件" rel="external nofollow"><i class="fa fa-fw fa-envelope"></i>电子邮件</a>
                  
                </span>
              
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">taohi</span>

  

  
</div>


  










        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="总访客量">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="site-pv" title="总访问量">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.3.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.3.0"></script>



  



  





  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  
  

  

  
  <script type="text/javascript" src="/js/src/js.cookie.js?v=6.3.0"></script>
  <script type="text/javascript" src="/js/src/scroll-cookie.js?v=6.3.0"></script>


  

  

  

</body>
</html>
